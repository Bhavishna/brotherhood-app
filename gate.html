<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Support Gate | Brotherhood</title>
</head>
<body class="bg-[#020617] text-white p-6 flex items-center justify-center min-h-screen font-sans">
    <div class="max-w-md w-full bg-slate-900 p-10 rounded-3xl border border-emerald-500/30 shadow-2xl">
        <h2 class="text-emerald-500 font-bold uppercase tracking-widest text-xs mb-2">Gate Requirement: Give Strength</h2>
        <div id="burdenDisplay" class="bg-slate-800/50 p-6 rounded-2xl italic text-slate-200 text-lg mb-8 border-l-4 border-emerald-500">
            "Loading a brother's burden..."
        </div>
        <textarea id="reply" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 mb-4 outline-none focus:ring-2 focus:ring-emerald-500 text-white" placeholder="Type a word of strength (Min 10 chars)..."></textarea>
        <button id="unlockBtn" class="w-full bg-emerald-600 py-4 rounded-xl font-bold hover:bg-emerald-500 transition-all active:scale-95">Unlock Dashboard</button>
    </div>

    <script type="module">
        import { db, auth } from './app.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, getDocs, updateDoc, doc, arrayUnion, setDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let targetId = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = 'index.html';
            const snap = await getDocs(collection(db, "burdens"));
            const others = snap.docs.filter(d => d.data().author !== user.uid);
            if (others.length > 0) {
                const random = others[Math.floor(Math.random() * others.length)];
                targetId = random.id;
                document.getElementById('burdenDisplay').innerText = `"${random.data().text}"`;
            } else { window.location.href = 'dashboard.html'; }
        });

        document.getElementById('unlockBtn').onclick = async () => {
            const val = document.getElementById('reply').value;
            if(val.length < 10) return alert("Please provide a sincere message of at least 10 characters.");
            
            // 1. Send Strength to the other brother
            await updateDoc(doc(db, "burdens", targetId), { strengths: arrayUnion(val) });
            
            // 2. Award 10 Empathy Points to the user for passing the gate
            await setDoc(doc(db, "users", auth.currentUser.uid), { 
                points: increment(10),
                lastActive: serverTimestamp() 
            }, { merge: true });

            window.location.href = 'dashboard.html';
        };
    </script>
</body>
</html>
